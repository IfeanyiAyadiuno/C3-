{% extends "inspection/base.html" %}

{% block title %}Inspection Tickets | Consumer Car Care{% endblock %}

{% block content %}
<div class="card">
    <!-- Inspection Ticket List Title -->
    <h2>Inspection Tickets</h2>
    
    <!-- Search Box - å±…ä¸­å¯¹é½ -->
    <div style="display: flex; justify-content: center; margin: 20px 0;">
        <div style="position: relative; width: 50%;">
            <input type="text" id="searchInput" placeholder="Search by Ticket #, Company, or Vehicle Make" 
                   style="width: 100%; padding: 10px 35px 10px 15px; border-radius: 20px; border: 1px solid #ddd; font-size: 14px;"
                   onkeyup="searchTickets()">
            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #999;">ğŸ”</span>
        </div>
    </div>
    
    <!-- çŠ¶æ€æ¶ˆæ¯ -->
    {% if request.GET.updated %}
    <div id="statusMessage" style="background-color: #d4edda; color: #155724; padding: 10px; margin-bottom: 15px; border-radius: 4px; text-align: center;">
        æ“ä½œæˆåŠŸï¼å·²æ›´æ–°æ•°æ®ã€‚
    </div>
    <script>
        // 5ç§’åè‡ªåŠ¨éšè—æ¶ˆæ¯
        setTimeout(function() {
            var statusMsg = document.getElementById('statusMessage');
            if(statusMsg) statusMsg.style.display = 'none';
        }, 5000);
    </script>
    {% endif %}
    
    <!-- Inspection Ticket Table -->
    <div class="table">
        <!-- Table Header -->
        <div class="table-header" style="grid-template-columns: 40px 70px 100px 100px 90px 90px 80px 80px 100px 100px;">
            <div></div> <!-- Checkbox Column -->
            <div>Ticket #</div>
            <div>Company</div>
            <div>Vehicle Make</div>
            <div>Date</div>
            <div>Inspection Type</div>
            <div>Tag</div>
            <div>Priority</div>
            <div>Status</div>
            <div>Actions</div>
        </div>
        
        <!-- Table Data Rows -->
        <div id="ticketRows">
            {% for ticket in tickets %}
            <div class="table-row" style="grid-template-columns: 40px 70px 100px 100px 90px 90px 80px 80px 100px 100px;">
                <div><input type="checkbox"></div>
                <div>{{ ticket.ticket_number }}</div>
                <div>{{ ticket.company }}</div>
                <div>{{ ticket.vehicle_make }}</div>
                <div>{{ ticket.date_created|date:"Y-m-d" }}</div>
                <div>{{ ticket.inspection_type }}</div>
                <div>{{ ticket.tag }}</div>
                <div>
                    <span {% if ticket.priority == 'Critical' %}style="color: red;"{% endif %}>
                        {{ ticket.priority }}
                    </span>
                </div>
                <div>
                    <span {% if ticket.status == 'Assigned' %}style="color: green; font-weight: bold;"{% endif %}
                          {% if ticket.status == 'Open' %}style="color: orange; font-weight: bold;"{% endif %}
                          {% if ticket.status == 'Completed' %}style="color: blue; font-weight: bold;"{% endif %}>
                        {{ ticket.status }}
                        {% if ticket.inspector %}
                        <br><small>({{ ticket.inspector.name }})</small>
                        {% endif %}
                    </span>
                </div>
                <div>
                    {% if ticket.status == 'Open' %}
                    <a href="{% url 'assign_inspector' %}?ticket_id={{ ticket.id }}" class="btn btn-primary">Assign</a>
                    {% elif ticket.status == 'Assigned' %}
                    <a href="{% url 'assign_inspector' %}?ticket_id={{ ticket.id }}" class="btn btn-primary" style="background-color: #28a745;">Reassign</a>
                    {% else %}
                    <a href="{% url 'assign_inspector' %}?ticket_id={{ ticket.id }}" class="btn btn-primary" style="background-color: #6c757d;">View</a>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="table-row" style="text-align: center; grid-template-columns: 1fr;">
                <div>No inspection tickets found.</div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Sample Data - Only for demonstration, can be deleted in actual use -->
        {% if not tickets %}
        <div class="table-row" style="grid-template-columns: 40px 70px 100px 100px 90px 90px 80px 80px 100px 100px;">
            <div><input type="checkbox"></div>
            <div>T00001</div>
            <div>Toyota North America</div>
            <div>Toyota Camry</div>
            <div>2023-01-10</div>
            <div>Rust Protection</div>
            <div>Tag 1</div>
            <div style="color: red;">Critical</div>
            <div style="color: orange; font-weight: bold;">Open</div>
            <div><button class="btn btn-primary">Assign</button></div>
        </div>
        <div class="table-row" style="grid-template-columns: 40px 70px 100px 100px 90px 90px 80px 80px 100px 100px;">
            <div><input type="checkbox"></div>
            <div>T00002</div>
            <div>Honda</div>
            <div>Civic</div>
            <div>2023-01-09</div>
            <div>Basic</div>
            <div>Critical</div>
            <div>Normal</div>
            <div style="color: green; font-weight: bold;">Assigned<br><small>(John Smith)</small></div>
            <div><button class="btn btn-primary" style="background-color: #28a745;">Reassign</button></div>
        </div>
        <div class="table-row" style="grid-template-columns: 40px 70px 100px 100px 90px 90px 80px 80px 100px 100px;">
            <div><input type="checkbox"></div>
            <div>T00003</div>
            <div>Honda</div>
            <div>Civic</div>
            <div>2023-01-09</div>
            <div>Standard</div>
            <div>No Tag Assigned</div>
            <div>Normal</div>
            <div style="color: orange; font-weight: bold;">Open</div>
            <div><button class="btn btn-primary">Assign</button></div>
        </div>
        <div class="table-row" style="grid-template-columns: 40px 70px 100px 100px 90px 90px 80px 80px 100px 100px;">
            <div><input type="checkbox"></div>
            <div>T00004</div>
            <div>Honda</div>
            <div>Civic</div>
            <div>2023-01-09</div>
            <div>Standard</div>
            <div>No Tag Assigned</div>
            <div>Critical</div>
            <div style="color: blue; font-weight: bold;">Completed</div>
            <div><button class="btn btn-primary" style="background-color: #6c757d;">View</button></div>
        </div>
        <div class="table-row" style="grid-template-columns: 40px 70px 100px 100px 90px 90px 80px 80px 100px 100px;">
            <div><input type="checkbox"></div>
            <div>T00005</div>
            <div>Honda</div>
            <div>Civic</div>
            <div>2023-01-08</div>
            <div>Standard</div>
            <div>Critical</div>
            <div>Normal</div>
            <div style="color: orange; font-weight: bold;">Open</div>
            <div><button class="btn btn-primary">Assign</button></div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // æ·»åŠ é¡µé¢åŠ è½½å®Œæˆåçš„åˆ·æ–°åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
        // å¦‚æœURLä¸­æœ‰updatedå‚æ•°ï¼Œå¼ºåˆ¶ä»æœåŠ¡å™¨åˆ·æ–°æ•°æ®
        if(window.location.href.includes('updated=')) {
            // æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶åˆ·æ–°é¡µé¢å†…å®¹
            var xhr = new XMLHttpRequest();
            xhr.open('GET', window.location.pathname, true);
            xhr.setRequestHeader('Cache-Control', 'no-cache');
            xhr.onload = function() {
                console.log('é¡µé¢å†…å®¹å·²åˆ·æ–°');
            };
            xhr.send();
        }
    });
    
    function searchTickets() {
        // è·å–è¾“å…¥å€¼å¹¶è½¬ä¸ºå°å†™
        var input = document.getElementById("searchInput");
        var filter = input.value.toLowerCase();
        
        // è·å–æ‰€æœ‰è¡Œ
        var rows = document.querySelectorAll("#ticketRows .table-row");
        
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è¡Œï¼Œè¯´æ˜å¯èƒ½æ˜¯ç¤ºä¾‹æ•°æ®ï¼Œåˆ™ä¸æ‰§è¡Œæœç´¢
        if (rows.length === 0) {
            return;
        }
        
        // éå†æ¯ä¸€è¡Œè¿›è¡Œç­›é€‰
        rows.forEach(function(row) {
            try {
                var ticketNumberEl = row.querySelector("div:nth-child(2)");
                var companyEl = row.querySelector("div:nth-child(3)");
                var vehicleMakeEl = row.querySelector("div:nth-child(4)");
                
                // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
                if (!ticketNumberEl || !companyEl || !vehicleMakeEl) {
                    // å¦‚æœæ˜¯"No inspection tickets found"çš„ä¿¡æ¯è¡Œï¼Œç›´æ¥è¿”å›
                    if (row.textContent.trim().includes("No inspection tickets found")) {
                        return;
                    }
                    // å¦åˆ™éšè—è¿™ä¸€è¡Œ
                    row.style.display = "none";
                    return;
                }
                
                var ticketNumber = ticketNumberEl.textContent.toLowerCase();
                var company = companyEl.textContent.toLowerCase();
                var vehicleMake = vehicleMakeEl.textContent.toLowerCase();
                
                // æ£€æŸ¥æ˜¯å¦åŒ¹é…
                if (ticketNumber.indexOf(filter) > -1 || 
                    company.indexOf(filter) > -1 || 
                    vehicleMake.indexOf(filter) > -1) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            } catch (error) {
                console.log("Error processing row:", error);
                // å‡ºé”™æ—¶ä¸æ”¹å˜è¡Œçš„æ˜¾ç¤ºçŠ¶æ€
            }
        });
    }
</script>
{% endblock %}
