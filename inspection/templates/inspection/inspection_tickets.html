{% extends "inspection/base.html" %}

{% block title %}Inspection Tickets | Consumer Car Care{% endblock %}

{% block content %}
<div class="card">
    <!-- Inspection Ticket List Title -->
    <h2>Inspection Tickets</h2>
    
    <!-- Search Box - 居中对齐 -->
    <div style="display: flex; justify-content: center; margin: 20px 0;">
        <div style="position: relative; width: 50%;">
            <input type="text" id="searchInput" placeholder="Search by Ticket #, Company, or Vehicle Make" 
                   style="width: 100%; padding: 10px 35px 10px 15px; border-radius: 20px; border: 1px solid #ddd; font-size: 14px;"
                   onkeyup="searchTickets()">
            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #999;">🔍</span>
        </div>
    </div>
    
    <!-- 状态消息 -->
    {% if request.GET.updated %}
    <div id="statusMessage" style="background-color: #d4edda; color: #155724; padding: 10px; margin-bottom: 15px; border-radius: 4px; text-align: center;">
        操作成功！已更新数据。
    </div>
    <script>
        // 5秒后自动隐藏消息
        setTimeout(function() {
            var statusMsg = document.getElementById('statusMessage');
            if(statusMsg) statusMsg.style.display = 'none';
        }, 5000);
    </script>
    {% endif %}
    
    <!-- Inspection Ticket Table -->
    <div class="table">
        <!-- Table Header -->
        <div class="table-header" style="grid-template-columns: 40px 70px 100px 100px 90px 90px 80px 80px 100px 100px;">
            <div></div> <!-- Checkbox Column -->
            <div>Ticket #</div>
            <div>Company</div>
            <div>Vehicle Make</div>
            <div>Date</div>
            <div>Inspection Type</div>
            <div>Tag</div>
            <div>Priority</div>
            <div>Status</div>
            <div>Actions</div>
        </div>
        
        <!-- Table Data Rows -->
        <div id="ticketRows">
            {% for ticket in tickets %}
            <div class="table-row" style="grid-template-columns: 40px 70px 100px 100px 90px 90px 80px 80px 100px 100px;">
                <div><input type="checkbox"></div>
                <div>{{ ticket.ticket_number }}</div>
                <div>{{ ticket.company }}</div>
                <div>{{ ticket.vehicle_make }}</div>
                <div>{{ ticket.date_created|date:"Y-m-d" }}</div>
                <div>{{ ticket.inspection_type }}</div>
                <div>{{ ticket.tag }}</div>
                <div>
                    <span {% if ticket.priority == 'Critical' %}style="color: red;"{% endif %}>
                        {{ ticket.priority }}
                    </span>
                </div>
                <div>
                    <span {% if ticket.status == 'Assigned' %}style="color: green; font-weight: bold;"{% endif %}
                          {% if ticket.status == 'Open' %}style="color: orange; font-weight: bold;"{% endif %}
                          {% if ticket.status == 'Completed' %}style="color: blue; font-weight: bold;"{% endif %}>
                        {{ ticket.status }}
                        {% if ticket.inspector %}
                        <br><small>({{ ticket.inspector.name }})</small>
                        {% endif %}
                    </span>
                </div>
                <div>
                    {% if ticket.status == 'Open' %}
                    <a href="{% url 'assign_inspector' %}?ticket_id={{ ticket.id }}" class="btn btn-primary">Assign</a>
                    {% elif ticket.status == 'Assigned' %}
                    <a href="{% url 'assign_inspector' %}?ticket_id={{ ticket.id }}" class="btn btn-primary" style="background-color: #28a745;">Reassign</a>
                    {% else %}
                    <a href="{% url 'assign_inspector' %}?ticket_id={{ ticket.id }}" class="btn btn-primary" style="background-color: #6c757d;">View</a>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="table-row" style="text-align: center; grid-template-columns: 1fr;">
                <div>No inspection tickets found.</div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Sample Data - Only for demonstration, can be deleted in actual use -->
        {% if not tickets %}
        <div class="table-row" style="grid-template-columns: 40px 70px 100px 100px 90px 90px 80px 80px 100px 100px;">
            <div><input type="checkbox"></div>
            <div>T00001</div>
            <div>Toyota North America</div>
            <div>Toyota Camry</div>
            <div>2023-01-10</div>
            <div>Rust Protection</div>
            <div>Tag 1</div>
            <div style="color: red;">Critical</div>
            <div style="color: orange; font-weight: bold;">Open</div>
            <div><button class="btn btn-primary">Assign</button></div>
        </div>
        <div class="table-row" style="grid-template-columns: 40px 70px 100px 100px 90px 90px 80px 80px 100px 100px;">
            <div><input type="checkbox"></div>
            <div>T00002</div>
            <div>Honda</div>
            <div>Civic</div>
            <div>2023-01-09</div>
            <div>Basic</div>
            <div>Critical</div>
            <div>Normal</div>
            <div style="color: green; font-weight: bold;">Assigned<br><small>(John Smith)</small></div>
            <div><button class="btn btn-primary" style="background-color: #28a745;">Reassign</button></div>
        </div>
        <div class="table-row" style="grid-template-columns: 40px 70px 100px 100px 90px 90px 80px 80px 100px 100px;">
            <div><input type="checkbox"></div>
            <div>T00003</div>
            <div>Honda</div>
            <div>Civic</div>
            <div>2023-01-09</div>
            <div>Standard</div>
            <div>No Tag Assigned</div>
            <div>Normal</div>
            <div style="color: orange; font-weight: bold;">Open</div>
            <div><button class="btn btn-primary">Assign</button></div>
        </div>
        <div class="table-row" style="grid-template-columns: 40px 70px 100px 100px 90px 90px 80px 80px 100px 100px;">
            <div><input type="checkbox"></div>
            <div>T00004</div>
            <div>Honda</div>
            <div>Civic</div>
            <div>2023-01-09</div>
            <div>Standard</div>
            <div>No Tag Assigned</div>
            <div>Critical</div>
            <div style="color: blue; font-weight: bold;">Completed</div>
            <div><button class="btn btn-primary" style="background-color: #6c757d;">View</button></div>
        </div>
        <div class="table-row" style="grid-template-columns: 40px 70px 100px 100px 90px 90px 80px 80px 100px 100px;">
            <div><input type="checkbox"></div>
            <div>T00005</div>
            <div>Honda</div>
            <div>Civic</div>
            <div>2023-01-08</div>
            <div>Standard</div>
            <div>Critical</div>
            <div>Normal</div>
            <div style="color: orange; font-weight: bold;">Open</div>
            <div><button class="btn btn-primary">Assign</button></div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // 添加页面加载完成后的刷新功能
    document.addEventListener('DOMContentLoaded', function() {
        // 如果URL中有updated参数，强制从服务器刷新数据
        if(window.location.href.includes('updated=')) {
            // 清除浏览器缓存并刷新页面内容
            var xhr = new XMLHttpRequest();
            xhr.open('GET', window.location.pathname, true);
            xhr.setRequestHeader('Cache-Control', 'no-cache');
            xhr.onload = function() {
                console.log('页面内容已刷新');
            };
            xhr.send();
        }
    });
    
    function searchTickets() {
        // 获取输入值并转为小写
        var input = document.getElementById("searchInput");
        var filter = input.value.toLowerCase();
        
        // 获取所有行
        var rows = document.querySelectorAll("#ticketRows .table-row");
        
        // 如果没有找到行，说明可能是示例数据，则不执行搜索
        if (rows.length === 0) {
            return;
        }
        
        // 遍历每一行进行筛选
        rows.forEach(function(row) {
            try {
                var ticketNumberEl = row.querySelector("div:nth-child(2)");
                var companyEl = row.querySelector("div:nth-child(3)");
                var vehicleMakeEl = row.querySelector("div:nth-child(4)");
                
                // 检查元素是否存在
                if (!ticketNumberEl || !companyEl || !vehicleMakeEl) {
                    // 如果是"No inspection tickets found"的信息行，直接返回
                    if (row.textContent.trim().includes("No inspection tickets found")) {
                        return;
                    }
                    // 否则隐藏这一行
                    row.style.display = "none";
                    return;
                }
                
                var ticketNumber = ticketNumberEl.textContent.toLowerCase();
                var company = companyEl.textContent.toLowerCase();
                var vehicleMake = vehicleMakeEl.textContent.toLowerCase();
                
                // 检查是否匹配
                if (ticketNumber.indexOf(filter) > -1 || 
                    company.indexOf(filter) > -1 || 
                    vehicleMake.indexOf(filter) > -1) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            } catch (error) {
                console.log("Error processing row:", error);
                // 出错时不改变行的显示状态
            }
        });
    }
</script>
{% endblock %}
